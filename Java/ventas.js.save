var Modulo = "ventas";
var Funcionalidad = {consultar: "consultar",busqueda: "busqueda"};
var configuracion = {};
var datos_abonos = {};
$( document ).ready(function() {
var datos;
var id_producto =0;
var id_cliente = 0;
FuncionesGeneral.template(Modulo,Funcionalidad.consultar,"#agregar_producto");
FuncionesGeneral.template(Modulo,Funcionalidad.busqueda,"#busqueda");

$("#abonos").hide();
$("#guardar_"+Modulo).hide();

var registro_configuracion = FuncionesGeneral.Consultar("configuracion");
for(indice in registro_configuracion){
  configuracion[indice] = registro_configuracion[indice]; 
}

$("#agregar_producto_"+Modulo).hide();
var registros = FuncionesGeneral.Consultar(Modulo);

$("#consultar_"+Modulo).hide();
	$( "#busqueda_cliente" ).autocomplete({
      source: function( request, response ) {
      	datos = ObtenerRegistrosbusqueda("clientes",request.term);
        response(datos);
      },
      select: function( event, objeto ) {
      	arreglo = objeto.item.value.split("-");
      	id_cliente = arreglo[0].trim();
      	registro_cliente = FuncionesGeneral.ObtenerRegistro("clientes",id_cliente);
      	$('#rfc').html("RFC: "+registro_cliente[0].rfc);
      },
      change: function( event, objeto ) {
        if(objeto.item == null){
          $('#rfc').html("");
          $('#busqueda_cliente').val("");
          id_cliente = 0; 
        }
      },
      minLength: 3
    });

    $( "#busqueda_articulo" ).autocomplete({
      source: function( request, response ) {
        datos = ObtenerRegistrosbusqueda("articulos",request.term);
        response(datos);
      },
      select: function( event, objeto ) {
        arreglo = objeto.item.value.split("-");
        id_producto = arreglo[0].trim();
       // registro = FuncionesGeneral.ObtenerRegistro("articulos",id_producto);
      },
      change: function( event, objeto ) {
         if(objeto.item  == null){ 
           id_producto = 0;
           $('#busqueda_articulo').val("");
         }
      },
      minLength: 3
    });

    $(document).on("click","#agregar_productos_detalle_venta",function(e){
        if(!id_producto){
          $('#mensaje').html("Es necesario ingresar un articulo.");
          return false;
        }
        registro_articulo = FuncionesGeneral.ObtenerRegistro("articulos",id_producto);
        if(registro_articulo[0].existencia < 1){
          $("#agregar_producto_"+Modulo).hide();
          $('#mensaje').html("El articulo seleccionado no cuenta con existencia, favor de verificar.");
          id_producto = 0;
          $('#busqueda_articulo').val("");
        }else{
          $('#mensaje').html("");
            if(!RecorrerTabla(registro_articulo[0].id)){
              $('#mensaje').html("Este articulo ya esta seleccionado.");
               return false;
            }
           
	     var rows = $("#tabla_producto_venta tr").length;
	    if(rows == 0){
	             FuncionesGeneral.template(Modulo,Funcionalidad.consultar,"#agregar_producto");
            }  
               $('#agregar_producto_'+Modulo).show();
	    AgregarProductoVentaTabla(registro_articulo);
        }
        e.preventDefault();
    });

    
    
    $( document ).on("change",".cantidad_producto",function(event) {
        var arreglo = event.target.id.split("_");
        var id = arreglo[1];
        var cantidad = $('#cantidad_'+id).val();
        datos = FuncionesGeneral.ObtenerRegistro("articulos",id);
        if(parseInt(cantidad) > parseInt(datos[0].existencia)){
          alert("Ingrese una cantidad menor o igual, su existencia es de "+parseInt(datos[0].existencia));
          $("#cantidad_"+id).val(cantidad);
          return false;
        }
        var registroTabla = [];
        $(this).parents("tr").find("td").each(function(indice){
            registroTabla [indice] = $(this).html().trim();
        });
        var nuevoImporte = FormulasVenta.CalcularImporte(registroTabla[4],cantidad);
        $("#importe_"+id).html(nuevoImporte.toFixed(2));
        
        var nuevoEnganche = FormulasVenta.CalcularEnganche(configuracion[0].porcentaje_enganche,nuevoImporte);
        $("#enganche").html(nuevoEnganche.toFixed(2));

        var nuevoBonificacion = FormulasVenta.CalcularBonificacionEnganche(nuevoEnganche,configuracion[0].tasa_financiamiento,configuracion[0].plazo);
            $("#bonificacion").html(nuevoBonificacion.toFixed(2));

        var nuevoTotalAdeudo = FormulasVenta.TotalAdeudo(nuevoImporte,nuevoEnganche,nuevoBonificacion);
            $("#total_adeudo").html(nuevoTotalAdeudo.toFixed(2));
    });

    $(".cantidad").mouseenter(function(){
        $(this).removeAttr("disabled",true);
    });

    $(".cantidad_producto").mouseenter(function(){
        $(this).removeAttr("disabled",true);
    });

    $("#siguiente_"+Modulo).click(function(){
       var rows_productos= $("#tabla_producto_venta tr").length;
       if(parseInt(rows_productos) > 1 && parseInt(id_cliente) > 0){
          TablaAbonos();
          $("#siguiente_"+Modulo).hide();
          $("#guardar_"+Modulo).show();
       }else{
          $('#mensaje').html("");
          $('#mensaje').html("Los datos ingresados no son correctos, favor de verificar");
          return false;
       }
    });

    $("#guardar_"+Modulo).click(function(){
          var row = 0; 
          row  =  $('input:radio[name=optradio]:checked').parent().parent().find('td:first').html();
          if(parseInt(row) > 0){
                console.log(registro_cliente);
		console.log(registro_articulo);
		debugger;		
                //GuardarVenta()              
          }else{
            $('#mensaje').html("");
            $('#mensaje').html("Los datos ingresados no son correctos, favor de verificar");
            return false;
          }
    });

});

function TablaAbonos(){
  var rows = 4;
  var fila = "";
  var plazo = 0;
  var total_adeudo = $("#total_adeudo").html();
  for (var indice = 1; indice <= rows; indice++) {
    plazo += 3;
    //alert(plazo);
  //alert(indice);
   var precio_contado = FormulasVenta.PrecioContado(total_adeudo,configuracion[0].tasa_financiamiento,plazo);
   var total_pagar = FormulasVenta.TotalPagar(precio_contado,configuracion[0].tasa_financiamiento,plazo);
   var importe_abono = FormulasVenta.ImporteAbono(total_pagar,plazo);
   var importe_ahorro = FormulasVenta.ImporteAhorro(total_pagar,plazo);
   //datos_abonos[indice] = {precio_contado: precio_contado.toFixed(2),total_pagar: total_pagar.toFixed(2),importe_abono: importe_abono.toFixed(2),importe_ahorro: importe_ahorro.toFixed(2)};
    
    fila += "<tr>";
    fila += "<td hidden>"+indice+"</td>"
    fila += "<td>"+plazo+" ABONOS DE</td>"
    fila += "<td>TOTAL A PAGAR $"+total_pagar.toFixed(2)+"</td>"
    fila += "<td> $ "+precio_contado.toFixed(2)+"</td>"
    fila += "<td>SE AHORRA $"+importe_ahorro.toFixed(2)+"</td>"
    fila += "<td><input type='radio' id ='check_"+indice+"' name='optradio' value'"+indice+"' class ='radio'/>";
    fila += "</tr>";
  }
   $("#tabla_abonos").append(fila);
   $("#abonos").show();
}

function ObtenerRegistroTablaProducto(row){

}

function RecorrerTabla(idproducto){
  var bandera = true;
  $("#tabla_producto_venta tbody tr").each(function (index,row){
      $(this).children("td:first").each(function (index2){
             console.log($(this).text());
debugger;
          if(parseInt($(this).text()) == parseInt(idproducto)){
              bandera = false;
          }
      });
  });
  return bandera;
}

var FormulasVenta = (function(){
    var CalcularPrecio = function(precio,tasa_financiamiento,plazo_maximo){
         return parseFloat(precio) * (1+(parseFloat(tasa_financiamiento) * parseInt(plazo_maximo))/100);
    }

    var CalcularImporte = function(precio,cantidad){
       return parseFloat(precio) * parseInt(cantidad);
    }

    var CalcularEnganche = function(porcentaje_enganche,importe){
      return (parseInt(porcentaje_enganche)/100) * parseFloat(importe);
    }

    var CalcularBonificacionEnganche = function(enganche,tasa_financiamiento,plazo_maximo){
      return parseFloat(enganche) * ((parseInt(tasa_financiamiento) * parseInt(plazo_maximo))/100);
    }

    var TotalAdeudo = function(importe,enganche,bonificaciones_enganche){
       return (parseFloat(importe) - parseFloat(enganche) - parseFloat(bonificaciones_enganche));
    }

    var PrecioContado = function(total_adeudo,tasa_financiamiento,plazo_maximo){
      return parseFloat(total_adeudo) / (1+((parseFloat(tasa_financiamiento) * parseInt(plazo_maximo))/100));
    }

    var TotalPagar = function(precio_contado,tasa_financiamiento,plazo_abono){
      return parseFloat(precio_contado) * (1 +(parseFloat(tasa_financiamiento) * parseInt(plazo_abono))/100);
    }

    var ImporteAbono = function(total_pagar,plazo_abono){
      return parseFloat(total_pagar) / parseInt(plazo_abono);
    }

    var ImporteAhorro = function(total_adeudo,total_pagar){
      return parseFloat(total_adeudo) - parseFloat(total_pagar);
    }

    return {
      CalcularPrecio: CalcularPrecio,
      CalcularImporte: CalcularImporte,
      CalcularEnganche: CalcularEnganche,
      CalcularBonificacionEnganche: CalcularBonificacionEnganche,
      TotalAdeudo: TotalAdeudo,
      PrecioContado: PrecioContado,
      ImporteAbono: ImporteAbono,
      ImporteAhorro: ImporteAhorro,
      TotalPagar: TotalPagar
    }

})();


function eliminar(idregistro){
  $("#tabla_producto_venta tbody tr").each(function (index,row){
      if(!RecorrerTabla(idregistro)){
          row.remove();
	debugger;
      }
  });
  $("#tabla_producto_venta tbody tr").find('td:first').each(function(index,row){
           if(parseInt($(this).text()) == parseInt(idregistro) ){
	          
	   }
  });
}

function AgregarProductoVentaTabla(datos){
            var nuevaFila="<tr >";

         //   console.log(configuracion);
            var CantidadProductoDefault = 1;
            var Precio = FormulasVenta.CalcularPrecio(datos[0].precio,configuracion[0].tasa_financiamiento,configuracion[0].plazo);            
            Precio = Precio.toFixed(2);
            var Importe = Precio * CantidadProductoDefault;
	    nuevaFila+="<td hidden>"+datos[0].id+" ";
            nuevaFila+="<td>"+datos[0].codigo+" ";
            nuevaFila+="<td>"+datos[0].descripcion+" ";
            nuevaFila+="<td>"+datos[0].modelo+" ";
            nuevaFila+="<td id='cantidad'><input type='text' class='cantidad_producto' id='cantidad_"+datos[0].id+"' value='1' />";
            nuevaFila+="<td>"+Precio+" ";
            nuevaFila+="<td id = 'importe_"+datos[0].id+"' >"+Importe+" ";
            nuevaFila+="<td><a href='#' class ='eliminar' onclick='eliminar("+datos[0].id+");' id='eliminar_"+datos[0].id+"'>Eliminar</a> ";
            nuevaFila+="</tr>";
            $("#tabla_producto_venta").append(nuevaFila);

            var enganche = FormulasVenta.CalcularEnganche(configuracion[0].porcentaje_enganche,Importe);
            $("#enganche").html(enganche.toFixed(2));
            var bonificacion = FormulasVenta.CalcularBonificacionEnganche(enganche,configuracion[0].tasa_financiamiento,configuracion[0].plazo);
            $("#bonificacion").html(bonificacion.toFixed(2));
            var TotalAdeudo = FormulasVenta.TotalAdeudo(Importe,enganche,bonificacion);
            $("#total_adeudo").html(TotalAdeudo.toFixed(2));
    //          Precio = Precio Articulo X (1 + (Tasa Financiamiento X Plazo Máximo) /100)
    
  }

function ObtenerRegistrosbusqueda(modulo,request){
var resultado;
	if(Vacio(modulo)){
		return false;
	}
	$.ajax({
		method: "POST",
  		url: "../../php/busqueda.php",
  		data: { modulo: modulo, texto: request},
  		async: false,
  		success: function(datos){
  			resultado = JSON.parse(datos);
  		},
  		error: function (error){
  			console.log("Error "+error);
  		}
	});
	return resultado;
}
